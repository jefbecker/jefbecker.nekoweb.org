<!DOCTYPE html>
<html id="top" lang="pt-BR">

<head>
    <title>Um Script Para Scrobbles do Last.FM | jefbecker</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Um Script Para Scrobbles do Last.FM">
    <meta name="fediverse:creator" content="@jefbecker@mastodon.social">
    <meta property="og:image" content="https://jefbecker.com/images/buttons/jefbecker/card_cube_cyan.webp">
    <meta property="article:published_time" content="2025-01-26T08:00-03:00">
    <link rel="canonical" href="https://jefbecker.com/br/paginas/blog/20250126-um-script-para-scrobbles-do-lastfm.html">
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="alternate" type="application/atom+xml" title="RSS Feed in English" href="https://jefbecker.com/feed/rss.xml">
    <link rel="alternate" type="application/atom+xml" title="Feed RSS em Português do Brasil" href="https://jefbecker.com/br/feed/rss.xml">
    <link rel="me" href="https://mastodon.social/@jefbecker">
    <link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>
    <a href="#main" class="skip-to-main-content-link">Pular para o conteúdo principal</a>
    <header>
        <img src="/images/jefbecker.png" title="JEFBECKER" style="display: inline-block;" class="center" alt="JEFBECKER LOGO" width="60" height="60">
        <nav class="btn nav-flex-container">
            <a title="Ir para o Início" href="/br/">Início</a>
            <a title="Ir para Páginas" class="active current" href="/br/paginas/">Páginas</a>
            <a title="Ir para Arquivo" href="/br/arquivo/">Arquivo</a>
            <a title="Ir para Links" href="/br/links/">Links</a>
            <a title="Ir para Feeds RSS" href="/br/feed/">Feed</a>
        </nav>
    </header>

    <div class="btn">
        <span><a title="Switch to English" href="/pages/blog/20250126-a-script-for-lastfm-scrobbles.html">English</a></span>
        <span><a title="Mudar para Português" class="active current" href="/br/paginas/blog/20250126-um-script-para-scrobbles-do-lastfm.html">Português</a></span>
    </div>

    <main id="main">
        <h1 id="um-script-para-scrobbles-do-lastfm" class="title">Um Script Para Scrobbles do Last.FM</h1>
        <code><time datetime="2025-03-30" title="30 Mar 2025 21:00">30 Mar 2025 | Domingo | 21:00</time></code>
    
        <article>
            <p>Em algum momento de 2024, eu procurei por um script que exibisse as músicas do Last.FM no meu site com mais informações que o código da <a title="Last.fm last-played powered by @biancarosa" href="https://github.com/biancarosa/lastfm-last-played">@biancarosa</a>. O script dela é ótimo, só que ele mostra apenas o nome da música e eu queria exibir a capa do álbum. Bom, eu encontrei a solução pra esse problema e só levei um ano pra implementar! Veja como:</p>
            <h2 id="primeiro-o-script-depois-explico">Primeiro o Script, Depois Explico</h2>
            <p>Em primeiro lugar, <a href="https://support.last.fm/t/last-fm-wordpress-plugin-displaying-scrobbles-and-last-played-on-your-site/57425/6">o script está disponível aqui</a>, se quiser fazer tudo por conta própria.</p>
            <p>Você vai precisar de duas coisas:</p>
            <div class="boxsizingBorder">
                <textarea>class LastFmRecentTracks {

          constructor(apiKey, user, limit, showNowPlaying, cacheTime, domId) {
              this.apiKey = apiKey;
              this.user = user;
              this.limit = limit;
              this.showNowPlaying = showNowPlaying;
              this.cacheTime = cacheTime;
              this.domContainer = document.getElementById(domId);
              if (!this.domContainer) {
                  throw new Error("Invalid Last.fm DOM container ID: " + domId);
              }
          }
      
          run() {
              let cachedRecentTracks = null;
              try {
                  cachedRecentTracks = this.loadRecentTracksFromCache();
              } catch (err) {}
      
              if (cachedRecentTracks) {
                  try {
                      this.render(cachedRecentTracks);
                  } catch (err) {
                      this.renderError(err);
                  }
              } else {
                  this.loadRecentTracks();
              }
          }
      
          loadRecentTracks() {
              fetch(this.buildUrl())
                  .then(response => {
                      if (!response.ok) {
                          throw new Error(response.statusText);
                      }
                      return response.json();
                  })
                  .then(data => {
                      this.updateCache(data);
                      this.render(data);
                  })
                  .catch(err => this.renderError(err));
          }
      
          buildUrl() {
              return `https://ws.audioscrobbler.com/2.0/?method=user.getRecentTracks&api_key=${this.apiKey}&user=${encodeURIComponent(this.user)}&limit=${this.limit}&format=json`;
          }
      
          loadRecentTracksFromCache() {
              if (this.cacheTime > 0) {
                  const cachedRecentTracksString = window.localStorage.getItem(this.cacheKey());
                  if (cachedRecentTracksString) {
                      const cachedRecentTracks = JSON.parse(cachedRecentTracksString);
                      if (cachedRecentTracks.user === this.user
                          && (this.nowTimestamp() - cachedRecentTracks.timestamp) <= this.cacheTime) {
                          return cachedRecentTracks.data;
                      }
                  }
              }
              return null;
          }
      
          updateCache(data) {
              if (this.cacheTime > 0) {
                  const cacheItem = JSON.stringify({timestamp: this.nowTimestamp(), user: this.user, data});
                  window.localStorage.setItem(this.cacheKey(), cacheItem);
              }
          }
      
          render(data) {
              if (!data.recenttracks) {
                  throw new Error("Invalid response");
              }
              const rawTracks = data.recenttracks.track;
              const hasNowPlaying = rawTracks[0]['@attr']?.nowplaying;
              const tracks = !this.showNowPlaying && hasNowPlaying ? rawTracks.slice(1) : rawTracks.slice(0, this.limit);
              this.domContainer.innerHTML = tracks.map(track => this.template(track)).join('');
          }
      
          template(track) {
              let image = track.image.find(img => img.size === "medium");
              if (!image || !image['#text']) {
                  image = "https://lastfm.freetls.fastly.net/i/u/64s/2a96cbd8b46e442fc41c2b86b821562f.png";
              } else {
                  image = image['#text'];
              }
      
              const date = track['@attr']?.nowplaying ? "Now playing" : track.date['#text'];
      
              return this.html`
                  <div style="display:flex;margin-bottom:1em">
                      <div style="flex:0 0 64px;margin-right:1em">
                          <img src="${image}">
                      </div>
                      <div>
                          <strong><a target="_blank" href="${track.url}">${track.name}</a></strong><br>
                          ${track.artist['#text']}<br>
                          <small>${date}</small>
                      </div>
                  </div>`;
          }
      
          renderError(err) {
              console.error(err);
              this.domContainer.innerHTML = `<div style="color:red">Error loading recent tracks from Last.fm</div>`;
          }
      
          html(literals, ...subs) {
              return literals.raw.reduce((acc, literal, i) => {
                  let sub = subs[i - 1];
                  if (Array.isArray(sub)) {
                      sub = sub.join('');
                  }
                  sub = this.escapeHtml(sub);
                  return acc + sub + literal;
              });
          }
      
          escapeHtml(unsafe) {
              return unsafe.replace(/[&<>"'`]/g, match => {
                  switch (match) {
                      case '&':
                          return "&amp;";
                      case '<':
                          return "&lt;";
                      case '>':
                          return "&gt;";
                      case '"':
                          return "&quot;";
                      case '\'':
                          return "&#039;";
                      case '`':
                          return "&#96;";
                  }
              });
          }
      
          nowTimestamp() {
              return Math.floor(Date.now() / 1000);
          }
      
          cacheKey() {
              return "lastfm_recent_tracks_cache";
          }
      }
      
      const lastfm = new LastFmRecentTracks("YOUR API KEY", "hemorrlloyd", 5, true, 600, "lastfm");
      lastfm.run();</textarea>
            </div>



            <ul>
                <li>Uma conta com acesso à API do Last.FM;</li>
                <li>Que o seu site permita conexão remota;</li>

            </ul>
            <p>PPPPPPPPPPPPPPPPPPPPPPPPPPPP</p>
            <h2>HHHHHHHHHHHHHHHHHHHHHHHHHHH</h2>
            <p>PPPPPPPPPPPPPPPPPPPPPPPPPPPP</p>
            <hr>
            <details>
                <summary>Clique para ler as regras antes de comentar.</summary>
                <ul>
                    <li>É proibido:
                        <ul>
                            <li>Discurso de ódio;</li>
                            <li>Propagandas;</li>
                            <li>Spam;</li>
                            <li>Assédio;</li>
                            <li>Links maliciosos;</li>
                        </ul>
                    </li>
                    <br>
                    <li>É recomendado:
                        <ul>
                            <li>Não publicar informações pessoais;</li>
                            <li>Ter respeito com os outros;</li>
                        </ul>
                    </li>

                    <br>
                    <li>Sobre a moderação:
                        <ul>
                            <li>Tenha em mente que este não é um espaço "livre" e que eu tenho total controle sobre o que pode ou não ser exibido, bem como tenho autonomia para alterar quaisquer informações que não estejam de acordo com as regras ou até mesmo impedir que sua mensagem apareça na página.</li>
                        </ul>
                    </li>
                    <br>
                    <li>OBS: O seu comentário ficará conectado a URL da página, de acordo com o idioma escolhido. Se comentar em um idioma, ele não aparecerá em outro e vice-versa. Você pode mudar o idioma nos botões no topo da página ou até mesmo comentar duas vezes, uma em cada página. Se precisar remover, alterar/corrigir algo, entre em <a href="/br/paginas/contato/">contato</a>.</li>
                </ul>
            </details>
            <br>
            <div id="comentarios-form"></div>
        </article>
    </main>

    <div class="bottom-nav-flex-container">
        <code><a href="">⇦ Próximo</a></code>
        <code><a href="#top">⇧ Topo</a></code>
        <code><a href="">Anterior ⇨</a></code>
    </div>

    <footer>
        <a href="/br/paginas/acessibilidade/" title="Acessibilidade">Acessibilidade</a>&ensp;
        <a href="/br/paginas/contato/" title="Entre em contato">Contato</a>&ensp;
        <a href="/br/paginas/privacidade/" title="Política de Privacidade">Privacidade</a>&ensp;
        <a href="/br/paginas/recursos/" title="Recursos">Recursos</a>&ensp;
        <a href="/br/paginas/sobre/" title="Sobre">Sobre</a>&ensp;
        <br>
        <p><a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" title="Licença Creative Commons - CC-BY-NC-SA 4.0">CC-BY-NC-SA 4.0</a></p>
        <img src="/88x31.png" class="center" aria-hidden="true" alt="Botão 88x31" width="88" height="31" loading="lazy">
        <p id="date">Desde 30 de Jul 2021</p>
        <noscript>
            <hr>
            <p><span class="emoji" aria-hidden="true">⚠️ </span>Você está navegando com JavaScript desabilitado. Eu fiz o possível para que as funções básicas e de navegação do site não dependam de JavaScript para funcionar, mas elementos interativos como botões de acionamento, formulários e conteúdo remoto ainda precisam dessa função.</p>
        </noscript>
    </footer>
    <script src="/scripts/since_br.js" defer></script>
    <script src="/comment-widget/comentarios.js" defer></script>
</body>

</html>